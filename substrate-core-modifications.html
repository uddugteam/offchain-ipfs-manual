<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Substrate Core Modifications - The offchain::ipfs Manual</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="getting-started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="using-the-docker-image.html"><strong aria-hidden="true">2.1.</strong> Using the Docker image</a></li><li class="chapter-item expanded "><a href="previewing-functionality.html"><strong aria-hidden="true">2.2.</strong> Previewing the functionality with a nice UI</a></li></ol></li><li class="chapter-item expanded "><a href="building-an-offchain-ipfs-app.html"><strong aria-hidden="true">3.</strong> Building an offchain::ipfs app</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="template-pallet.html"><strong aria-hidden="true">3.1.</strong> Example Pallet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="offchain-ipfs-callables.html"><strong aria-hidden="true">3.1.1.</strong> Callables reference</a></li></ol></li><li class="chapter-item expanded "><a href="offchain-ipfs-javascript.html"><strong aria-hidden="true">3.2.</strong> JavaScript clients</a></li></ol></li><li class="chapter-item expanded "><a href="offchain-ipfs-architecture.html"><strong aria-hidden="true">4.</strong> Architectural Explanation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="building-offchain-ipfs-source.html"><strong aria-hidden="true">4.1.</strong> Building from Source</a></li><li class="chapter-item expanded "><a href="substrate-core-modifications.html" class="active"><strong aria-hidden="true">4.2.</strong> Substrate Core Modifications</a></li></ol></li><li class="chapter-item expanded "><a href="contributing-development.html"><strong aria-hidden="true">5.</strong> Contributing / Development</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The offchain::ipfs Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="substrate-core-modifications"><a class="header" href="#substrate-core-modifications">Substrate core modifications</a></h1>
<p>Every one of <code>offchain::ipfs</code>'s functional modifications to the <a href="https://github.com/paritytech/substrate"><code>paritytech/substrate</code></a> core are
encapsulated in a single commit on the <a href="https://github.com/uddugteam/substrate/tree/offchain-ipfs-v0.3"><code>offchain_ipfs</code></a> branch of our repo.</p>
<p>In this section we'll walk through these modifications so that you may understand them, and
perhaps improve upon them yourself.</p>
<h2 id="how-substrate-is-organized"><a class="header" href="#how-substrate-is-organized">How Substrate is organized</a></h2>
<p>Substrate, as a modular framework, provides:</p>
<ol>
<li><strong>Clients</strong> are services that interact with the substrate blockchain, e.g. substrate full and
light client. Offchain workers are one of those clients</li>
<li>Basic <strong>primitives</strong> to compose a blockchain with your desired features</li>
<li>Several <strong>binaries</strong>, both necessary and optional, that you can run or build from source</li>
</ol>
<p>There's definitely a lot more to Substrate, but for the purposes of this explanation we'll only
cover the parts that <code>offchain::ipfs</code> augments. At a very high level, we modeled this implementation
after the existing <a href="https://github.com/paritytech/substrate/blob/master/client/offchain/src/api/http.rs"><code>offchain::http</code></a> module. You can look that over to get a sense of how it all
works, or read on for more detail.</p>
<p>From here on, most of the links will be to code points within the <a href="https://github.com/uddugteam/substrate/tree/offchain-ipfs-v0.3"><code>offchain_ipfs</code></a> branch of the
<code>offchain::ipfs</code> repo.</p>
<h2 id="offchainipfs-lifecycle"><a class="header" href="#offchainipfs-lifecycle"><code>offchain::ipfs</code> lifecycle</a></h2>
<ol>
<li>
<p>User runs one of the binaries, <a href="https://github.com/uddugteam/substrate/tree/offchain-ipfs-v0.3/bin/node/cli"><code>node</code></a>, or <a href="https://github.com/uddugteam/substrate/tree/offchain-ipfs-v0.3/bin/node-template"><code>node-template</code></a> which launches a Substrate runtime.</p>
</li>
<li>
<p>If the offchain worker is enabled in the configuration, a secondary runtime will start in both
the <a href="https://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/service/src/builder.rs#L266">full client</a> and <a href="https://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/service/src/builder.rs#L333">light client</a> to power the IPFS node.</p>
</li>
<li>
<p>The client will use <a href="https://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/offchain/src/api/ipfs.rs#L69"><code>IpfsApi</code></a> and <a href="https://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/offchain/src/api/ipfs.rs#L249"><code>IpfsWorker</code></a> to expose its functionality
to any pallets that wish to access it, via <a href="https://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/offchain/src/api.rs#L189"><code>ipfs_request_start</code></a> and <a href="https://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/offchain/src/api.rs#L193"><code>ipfs_request_wait</code></a>.
These calls will utilize the types explained below.</p>
</li>
<li>
<p>If your node is configured to processes user input via a pallet, then users will make requests,
typically in the form of <strong><a href="hthttps://github.com/uddugteam/substrate/blob/offchain_ipfs-v0.3/client/offchain/src/api/ipfs.rs#L249tps://substrate.dev/docs/en/knowledgebase/learn-substrate/extrinsics">extrinsics</a></strong> called via JSON-RPC. A typical successful call goes
something like:</p>
<ol>
<li>The JSON-RPC server in the substrate node will recieve the call and it will be the dispatched
to the relevant pallet.</li>
<li>The pallet may store the calls in a queue to be handled later, or immediate create a valid
<code>IpfsRequest</code> with the call argument(s).</li>
<li>An Offchain Worker starts on each block import to handle the request to the IPFS node with its
exposed APIs.</li>
<li>When the IPFS node respond to the requests, the response is registered at the APIs as a
<code>IpfsResponse</code>. The offchain worker stops.</li>
<li>The response can be used to update a chain state through signed or unsigned transaction or be
used in the rest of the call's logic.</li>
</ol>
</li>
</ol>
<h2 id="primitive-types"><a class="header" href="#primitive-types">Primitive Types</a></h2>
<p>Offchain::ipfs adds the following types used in the substrate runtime and the offchain workers. It
is useful to explore some core types as they indicate the existing offchain::ipfs functions and
where to modify to add new functions to interact with IPFS.</p>
<blockquote>
<p><strong>Development Tip:</strong></p>
<p>In fact, you can let the <code>rustc</code> do a lot of work for you! By simply adding, changing, or
removing types from the following enums, you will get helpful errors telling you where else you
need to change your code to satisfy the compiler.</p>
</blockquote>
<h3 id="ipfsrequest"><a class="header" href="#ipfsrequest"><code>IpfsRequest</code></a></h3>
<p>An enum that represents a request to the IPFS node.</p>
<ul>
<li><code>Addrs</code> - Get the list of node's peerIds and addresses.</li>
<li><code>AddBytes(Vec&amp;lt;u8&amp;gt;)</code> - Add the given bytes to the IPFS repo</li>
<li><code>AddListeningAddr(OpaqueMultiaddr)</code> - Add an address to listen on.</li>
<li><code>BitswapStats</code> - Get the bitswap stats of the node.</li>
<li><code>CatBytes(Vec&lt;u8&gt;)</code> - Get bytes with the given Cid from the IPFS repo and display them.</li>
<li><code>Connect(OpaqueMultiaddr)</code> - Connect to an external IPFS node with the specified Multiaddr.</li>
<li><code>Disconnect(OpaqueMultiaddr)</code> - Disconnect from an external IPFS node with the specified Multiaddr.</li>
<li><code>GetBlock(Vec&lt;u8&gt;)</code> - Obtain an IPFS block.</li>
<li><code>FindPeer(Vec&lt;u8&gt;)</code> - Find the addresses related to the given PeerId.</li>
<li><code>GetClosestPeers(Vec&lt;u8&gt;)</code> - Get a list of PeerIds closest to the given PeerId.</li>
<li><code>GetProviders(Vec&lt;u8&gt;)</code> - Find the providers for the given Cid.</li>
<li><code>Identity</code> - Get the node's public key and dedicated external addresses.</li>
<li><code>InsertPin(Vec&lt;u8&gt;, bool)</code> - Pins a given Cid recursively or directly (non-recursively)</li>
<li><code>LocalAddrs</code> - Get the list of node's local addresses.</li>
<li><code>LocalRefs</code> - Get the list of <code>Cid</code>s of blocks known to a node.</li>
<li><code>Peers</code> - Obtain the list of node's peers.</li>
<li><code>Publish</code> - Publish a given message to a topic.
<ul>
<li><code>topic: Vec&lt;u8&gt;</code> - The topic to publish the message to.</li>
<li><code>message: Vec&lt;u8&gt;</code> - The message to publish.</li>
</ul>
</li>
<li><code>RemoveBlock(Vec&lt;u8&gt;)</code> - Remove a block from the ipfs repo. A pinned block cannot be removed.</li>
<li><code>RemoveListeningAddr(OpaqueMultiaddr)</code> - Remove an address that is listened on.</li>
<li><code>RemovePin(Vec&lt;u8&gt;, bool)</code> - Unpins a given Cid recursively or only directly.</li>
<li><code>Subscribe(Vec&lt;u8&gt;)</code> - Subscribe to a given topic.</li>
<li><code>SubscriptionList</code> - Obtain the list of currently subscribed topics.</li>
<li><code>Unsubscribe(Vec&lt;u8&gt;)</code> - Unsubscribe from a given topic.</li>
</ul>
<h3 id="ipfsresponse"><a class="header" href="#ipfsresponse"><code>IpfsResponse</code></a></h3>
<p>An enum that represents a response from the IPFS node.</p>
<ul>
<li><code>Addrs(Vec&lt;(Vec&lt;u8&gt;, Vec&lt;OpaqueMultiaddr&gt;)&gt;)</code> - A list of pairs of node's peers and
their known addresses.</li>
<li><code>AddBytes(Vec&lt;u8&gt;)</code> - The Cid of the added bytes.</li>
<li><code>BitswapStats</code> - A collection of node stats related to the bitswap protocol.
<ul>
<li><code>blocks_sent: u64</code> - The number of blocks sent.</li>
<li><code>data_sent: u64</code> - The number of bytes sent.</li>
<li><code>blocks_received: u64</code> - The number of blocks received.</li>
<li><code>data_received: u64</code> - The number of bytes received.</li>
<li><code>dup_blks_received: u64</code> - The number of duplicate blocks received.</li>
<li><code>dup_data_received: u64</code> - The number of duplicate bytes received.</li>
<li><code>peers: Vec&lt;Vec&lt;u8&gt;&gt;</code> - The list of peers.</li>
<li><code>wantlist: Vec&lt;(Vec&lt;u8&gt;, i32)&gt;</code> - The list of wanted CIDs and their bitswap priorities.</li>
</ul>
</li>
<li><code>CatBytes(Vec&lt;u8&gt;)</code> - The data received from IPFS.</li>
<li><code>FindPeer(Vec&lt;OpaqueMultiaddr&gt;)</code> - A list of addresses known to be related to a PeerId.</li>
<li><code>GetClosestPeers(Vec&lt;Vec&lt;u8&gt;&gt;)</code> - The list of PeerIds closest to the given PeerId.</li>
<li><code>GetProviders(Vec&lt;Vec&lt;u8&gt;&gt;)</code> - A list of PeerIds known to provide the given Cid.</li>
<li><code>Identity(Vec&lt;u8&gt;, Vec&lt;OpaqueMultiaddr&gt;)</code> - The local node's public key and the externally
visible and listened to addresses.</li>
<li><code>LocalAddrs(Vec&lt;OpaqueMultiaddr&gt;)</code> - A list of local node's externally visible and listened to addresses.</li>
<li><code>LocalRefs(Vec&lt;Vec&lt;u8&gt;&gt;)</code> - A list of locally available blocks by their Cids.</li>
<li><code>Peers(Vec&lt;OpaqueMultiaddr&gt;)</code> - The list of currently connected peers.</li>
<li><code>RemoveBlock(Vec&lt;u8&gt;)</code> - The Cid of the removed block.</li>
<li><code>Success</code> - A request was processed successfully and there is no extra value to return.</li>
</ul>
<h3 id="ipfsrequeststatus"><a class="header" href="#ipfsrequeststatus"><code>IpfsRequestStatus</code></a></h3>
<p>An enum that represents the status of an IPFS request.</p>
<ul>
<li><code>DeadlineReached</code> - Deadline was reached while we waited for this request to finish.</li>
<li><code>IoError(Vec&lt;u8&gt;)</code> - An error has occurred during the request, for example a timeout or the remote
has closed our socket.</li>
<li><code>Invalid</code> - The passed ID is invalid in this context.</li>
<li><code>Finished(IpfsResponse)</code> - The request has finished successfully.</li>
</ul>
<h3 id="ipfserror"><a class="header" href="#ipfserror"><code>IpfsError</code></a></h3>
<p>An enum that enumerates types of errors returned from the IPFS node.</p>
<ul>
<li><code>DeadlineReached = 1</code> - The requested action couldn't been completed within a deadline.</li>
<li><code>IoError = 2</code> - There was an IO Error while processing the request.</li>
<li><code>Invalid = 3</code> - The ID of the request is invalid in this context.</li>
</ul>
<p>We hope this has been a helpful overview of the core modifications that we made to Substrate in
order to enable embedded IPFS functionality. If you have questions, or if you're ready to jump in
and contribute, or if you're ready to build your own <code>offchain::ipfs</code>-powered dApp, read on.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="building-offchain-ipfs-source.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="contributing-development.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="building-offchain-ipfs-source.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="contributing-development.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
